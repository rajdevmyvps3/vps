name: Marin VPS

on:
  workflow_dispatch:
  repository_dispatch:

concurrency:
  group: marin-vps
  cancel-in-progress: true

permissions:
  actions: write
  contents: write

env:
  TZ: 'Asia/Kolkata'

jobs:
  ultimate-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
    # --- üìÇ FETCH CODE WITH PUSH PERMISSION ---
    - name: üìÇ Checkout Code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0

    - name: üü¢ Setup Node.js 22
      uses: actions/setup-node@v3
      with:
        node-version: '22'

    # --- üßπ SYSTEM CLEANUP & TOOL INSTALL ---
    - name: üßπ System Cleanup & Tools Install
      run: |
        echo "üßπ Clearing Disk Space..."
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost /usr/local/lib/android /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        
        sudo apt-get update -qq
        sudo apt-get install -y -qq ffmpeg imagemagick webp jq tmate neofetch ttyd
        
        sudo npm install -g pm2 localtunnel
        curl -fsSL https://raw.githubusercontent.com/filebrowser/get/master/get.sh | sudo bash
        
        # üî• SAFETY FIX: Tmate connect hone mein error na de isliye SSH key banayi hai
        ssh-keygen -t ed25519 -N "" -f ~/.ssh/id_ed25519

    # --- üíæ THE GHOST MODE AUTO-SYNC SCRIPT ---
    - name: üíæ Setup Ghost Auto-Save (savecode)
      run: |
        git config --global user.email "marin-bot@auto.sync"
        git config --global user.name "Marin Auto-Saver"
        
        # 403 Error Fix: Direct Auth
        git remote set-url origin https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git
        
        # üõë KACHRA BLOCKER: Heavy files GitHub pe na jayein
        echo "node_modules/" >> .gitignore
        
        # üëª GHOST MODE: Hide .github folder (marin.yml) completely!
        mv .github /tmp/.github_hidden
        
        # ü™Ñ MAGIC COMMAND: 'savecode' (Ab save.sh file nahi banegi)
        echo '#!/bin/bash' > savecode
        echo 'echo "‚è≥ Saving changes to GitHub..."' >> savecode
        echo 'mv /tmp/.github_hidden ./.github' >> savecode # Save karte waqt 1 sec ke liye lao
        echo 'git add .' >> savecode
        echo 'git commit -m "üíæ Auto-saved changes from Ghost Panel [skip ci]" || echo "No changes to save."' >> savecode
        echo 'git push origin HEAD || echo "‚ö†Ô∏è Push failed! Check PAT_TOKEN."' >> savecode
        echo 'mv ./.github /tmp/.github_hidden' >> savecode # Wapas chhupa do
        echo 'echo "‚úÖ Save Process Completed!"' >> savecode
        
        # Isko global command bana rahe hain
        sudo mv savecode /usr/local/bin/savecode
        sudo chmod +x /usr/local/bin/savecode

    - name: üîí Set SSH Password
      run: |
        echo "runner:${{ secrets.SSH_PASSWORD }}" | sudo chpasswd
        sudo usermod -aG sudo runner

    - name: üì¶ Install Dependencies
      run: npm install

    # --- üöÄ START BOT WITH PM2 ---
    - name: üöÄ Start Marin MD Bot (PM2)
      env:
        MONGODB: ${{ secrets.MONGODB }}
        MODS: ${{ secrets.MODS }}
        SESSION_ID: ${{ secrets.SESSION_ID }}
        PACKNAME: ${{ secrets.PACKNAME }}
      run: |
        pm2 start index.js --name "marin"
        pm2 save

    # --- üåê SUPER CLEAN WEB PANEL SETUP ---
    - name: üåê Start Web Panel & Web Terminal
      run: |
        set +e # üî• SHIELD: Agar 1 sec ka delay ho toh server crash na ho
        
        # Saare logs aur DB files ko /tmp/ mein bhej diya (File Manager clean rahega)
        filebrowser -r $(pwd) -p 8080 -a 0.0.0.0 --noauth -d /tmp/filebrowser.db > /tmp/filebrowser.log 2>&1 &
        sleep 2
        lt --port 8080 > /tmp/tunnel_file.log 2>&1 &
        sleep 8
        
        # Web Terminal
        ttyd -p 7681 bash > /tmp/ttyd.log 2>&1 &
        sleep 2
        lt --port 7681 > /tmp/tunnel_term.log 2>&1 &
        sleep 10
        
        FILE_URL=$(grep -o 'https://.*' /tmp/tunnel_file.log | head -n 1)
        TERM_URL=$(grep -o 'https://.*' /tmp/tunnel_term.log | head -n 1)
        SERVER_IP=$(curl -s ifconfig.me)
        
        echo "FILE_MANAGER_URL=${FILE_URL:-'‚ö†Ô∏è Link Failed'}" >> $GITHUB_ENV
        echo "WEB_TERMINAL_URL=${TERM_URL:-'‚ö†Ô∏è Link Failed'}" >> $GITHUB_ENV
        echo "SERVER_IP=${SERVER_IP:-'Unknown'}" >> $GITHUB_ENV

    # --- üîÑ TMATE DASHBOARD & TIMER ---
    - name: üîÑ Start Tmate Loop & Discord Alert
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        set +e # üî• SHIELD ON
        
        for i in {1..15}; do
           tmate -S /tmp/tmate.sock kill-session 2>/dev/null || true
           tmate -S /tmp/tmate.sock new-session -d
           tmate -S /tmp/tmate.sock wait tmate-ready
           sleep 5
           
           SSH_MSG=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' 2>/dev/null)
           WEB_MSG=$(tmate -S /tmp/tmate.sock display -p '#{tmate_web}' 2>/dev/null) # üî• MOBILE KEYBOARD FIX
           
           if [[ "$SSH_MSG" == *"tmate.io"* ]]; then
              
              PAYLOAD=$(jq -n \
                --arg ssh "$SSH_MSG" \
                --arg tmateWeb "$WEB_MSG" \
                --arg fileUrl "$FILE_MANAGER_URL" \
                --arg termUrl "$WEB_TERMINAL_URL" \
                --arg ip "$SERVER_IP" \
                '{content: "üö® **Marin VPS Dashboard** üö®\n\n‚úÖ **Status:** Online üü¢\n\nüìÅ **File Manager:** \($fileUrl)\nüîë **Login IP:** `\($ip)`\n\nüñ•Ô∏è **Tmate Web :** \($tmateWeb)\nüñ•Ô∏è **Local Web Terminal (PC):** \($termUrl)\nüíª **SSH:** `\($ssh)`\n\n_üí° Note: Run `savecode` to save code, then `pm2 restart marin` to apply changes!_"}')
              
              curl -H "Content-Type: application/json" -d "$PAYLOAD" $DISCORD_WEBHOOK
              
              # üî• SMART RESTART FLAG: Sirf 5h 45m baad hi server loop mein jayega
              echo "RESTART_SAFE=true" >> $GITHUB_ENV
              
              # Smart Timer (5 Hours 45 Mins)
              for m in {1..69}; do sleep 300; done
              
              # üî• AUTO-SAVE BEFORE RESTART
              echo "‚è≥ 5 Hours 45 Mins complete! Auto-saving to GitHub before restarting..."
              savecode || true
              exit 0
           fi
           sleep 5
        done
        
        # Agar Tmate connect nahi hua, toh bot ko infinite loop mein jaane se roko
        curl -H "Content-Type: application/json" -d '{"content": "‚ùå **ERROR:** Tmate Server failed. Auto-restart paused to prevent GitHub ban."}' $DISCORD_WEBHOOK
        exit 1

    # --- üßü AUTO RESTART LOOP ---
    - name: üßü Respawn Zombie
      if: env.RESTART_SAFE == 'true'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.PAT_TOKEN }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'marin.yml',
            ref: 'main'
          })
